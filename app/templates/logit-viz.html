<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Storyteller's Quill</title>
  
  <!-- Favicon - using a quill/feather emoji as data URI -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü™∂</text></svg>">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Old Book Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Cinzel:wght@400;700&family=Homemade+Apple&display=swap');

    /* 
      Theme Variables 
      --paper-bg: Warm, aged parchment
      --ink-color: Dark charcoal/brown
      --accent-gold: Dull gold
    */
    :root {
      --paper-color: #d8c8b0;
      --ink-color: #2c241b;
      --ink-faded: #5c4d3c;
      --leather-dark: #2a1810;
      --leather-light: #4a2c1d;
    }

    body {
      background-color: #1a120b;
      background-image: 
        radial-gradient(circle at 50% 0%, #2c1e14 0%, #1a120b 70%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233a2618' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2); 
    }
    ::-webkit-scrollbar-thumb {
      background: #5c4d3c; 
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #8c735a; 
    }

    /* Token Styling - Ink & Magic */
    .token {
      padding: 0 1px;
      margin: 0;
      transition: all 0.3s ease;
      cursor: help;
      font-family: 'Crimson Text', serif;
      font-size: 1.25rem;
      line-height: 1.8;
      display: inline;
      position: relative;
      border-bottom: 2px solid transparent;
      color: var(--ink-color);
    }
    
    .token:hover {
      transform: translateY(-1px);
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
      background-color: rgba(255, 245, 230, 0.5);
    }

    /* 
       Confidence Visualization: Magical Underlines & Auras
       Instead of blocky backgrounds, we use subtle text shadows and underlines
       that look like magical residue or ink variance.
    */

    /* Very High: Pure, dark ink */
    .token-confidence-very-high {
      color: #1a1a1a;
    }
    
    /* High: Slightly lighter ink */
    .token-confidence-high {
      color: #2d2d2d;
    }
    
    /* Good: Sepia tint (uncertainty creeping in) */
    .token-confidence-good {
      color: #5d4037;
      border-bottom: 1px dotted rgba(160, 100, 50, 0.3);
    }
    
    /* Medium: Noticeably faded/brown */
    .token-confidence-medium {
      color: #8d6e63;
      border-bottom: 1px dotted rgba(160, 100, 50, 0.6);
      background-color: rgba(255, 230, 200, 0.2);
    }
    
    /* Low: Reddish/Rust tint (the magic is unstable) */
    .token-confidence-low {
      color: #a14545;
      border-bottom: 2px dotted rgba(200, 80, 80, 0.4);
      background-color: rgba(255, 220, 220, 0.2);
    }
    
    /* Very Low: Distinct red, unstable look */
    .token-confidence-very-low {
      color: #c62828;
      text-shadow: 0 0 2px rgba(198, 40, 40, 0.2);
      border-bottom: 2px wavy rgba(198, 40, 40, 0.5);
    }
    
    .token-punctuation {
      color: var(--ink-faded);
    }

    /* Paper Sheet Effect */
    .paper-sheet {
      background-color: var(--paper-color);
      background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
      background-blend-mode: multiply;
      box-shadow: 
        0 1px 1px rgba(0,0,0,0.15), 
        0 10px 0 -5px #eee, 
        0 10px 1px -4px rgba(0,0,0,0.15), 
        0 20px 0 -10px #eee, 
        0 20px 1px -9px rgba(0,0,0,0.15),
        0 0 20px rgba(0,0,0,0.2);
      border: 1px solid #e6e0d0;
    }

    /* Handwriting Header */
    .handwriting {
      font-family: 'Homemade Apple', cursive;
    }
    
    /* Cinematic Header */
    .cinzel {
      font-family: 'Cinzel', serif;
    }

    /* Smooth scrolling for the heatmap container */
    #heatmap-text {
      scroll-behavior: smooth;
    }
    
    /* Tooltip styled like a marginalia note */
    #token-tooltip {
      font-family: 'Crimson Text', serif;
      background: #d8c8b0;
      border: 1px solid #d4c5b0;
      box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="min-h-screen text-[#2c241b]">
  
  <!-- Loading Overlay (Parchment Style) -->
  <div id="loading-overlay" class="fixed inset-0 bg-[#1a120b] bg-opacity-90 flex items-center justify-center z-50">
    <div class="bg-[#d8c8b0] rounded-sm shadow-2xl p-8 max-w-md w-full mx-4 border-4 border-double border-[#4a2c1d] relative" style="background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png'); background-blend-mode: multiply;">
      
      <div class="flex flex-col items-center text-center mb-6 relative z-10">
        <div class="mb-4 text-4xl">‚úíÔ∏è</div>
        <h2 class="text-2xl font-bold text-[#2a1810] cinzel tracking-wider">Preparing the Quill</h2>
      </div>
      
      <div class="space-y-4 relative z-10">
        <!-- Model Selection -->
        <div class="mb-4 text-left" id="model-selection-container">
          <label class="block text-[#5c4d3c] font-serif text-sm italic mb-2">Choose your storyteller:</label>
          
          <!-- Featured Models -->
          <div id="featured-models" class="space-y-2">
            <label class="model-option flex items-center p-3 border border-[#d4c5b0] rounded bg-[#efe6d5] hover:bg-[#e6e0d0] cursor-pointer transition-colors group">
              <input type="radio" name="model-choice" value="Hermes-3-Llama-3.1-8B-q4f16_1-MLC" class="hidden peer" checked>
              <div class="w-4 h-4 border-2 border-[#8d6e63] rounded-full mr-3 flex items-center justify-center peer-checked:border-[#2a1810] peer-checked:bg-[#2a1810]">
                <div class="w-1.5 h-1.5 bg-white rounded-full peer-checked:block hidden"></div>
              </div>
              <div class="flex-1">
                <div class="font-serif font-bold text-[#2a1810]">The Grand Bard</div>
                <div class="text-xs text-[#5c4d3c] italic">Llama 3.1 8B ¬∑ ~5GB ¬∑ Eloquent & Detailed</div>
              </div>
            </label>

            <label class="model-option flex items-center p-3 border border-[#d4c5b0] rounded bg-[#efe6d5] hover:bg-[#e6e0d0] cursor-pointer transition-colors group">
              <input type="radio" name="model-choice" value="Qwen2.5-0.5B-Instruct-q4f16_1-MLC" class="hidden peer">
              <div class="w-4 h-4 border-2 border-[#8d6e63] rounded-full mr-3 flex items-center justify-center peer-checked:border-[#2a1810] peer-checked:bg-[#2a1810]">
                <div class="w-1.5 h-1.5 bg-white rounded-full peer-checked:block hidden"></div>
              </div>
              <div class="flex-1">
                <div class="font-serif font-bold text-[#2a1810]">The Apprentice</div>
                <div class="text-xs text-[#5c4d3c] italic">Qwen 0.5B ¬∑ ~1GB ¬∑ Swift & Simple</div>
              </div>
            </label>
          </div>

          <!-- Browse Library (Expandable) -->
          <details id="library-browser" class="mt-3 group">
            <summary class="flex items-center cursor-pointer text-[#5c4d3c] hover:text-[#2a1810] text-sm font-serif py-2 select-none">
              <span class="mr-2">üìö</span>
              <span class="italic">Browse the Library...</span>
              <span class="ml-auto transform transition-transform group-open:rotate-180">‚ñæ</span>
            </summary>
            
            <div class="mt-2 p-3 bg-[#e6e0d0] rounded border border-[#d4c5b0] space-y-3">
              <!-- Search & Filters -->
              <div class="flex gap-2">
                <input type="text" 
                       id="model-search" 
                       placeholder="Search tomes..." 
                       class="flex-1 px-2 py-1 text-sm border border-[#bcaaa4] rounded bg-[#fffef8] font-serif placeholder-[#a1887f] focus:outline-none focus:border-[#8d6e63]">
                <select id="family-filter" class="px-2 py-1 text-sm border border-[#bcaaa4] rounded bg-[#fffef8] font-serif text-[#5c4d3c] focus:outline-none focus:border-[#8d6e63]">
                  <option value="All">All Families</option>
                </select>
              </div>
              
              <!-- Model List -->
              <div id="model-list" class="max-h-48 overflow-y-auto space-y-1 pr-1">
                <p class="text-xs text-[#8c735a] italic text-center py-4">Loading ancient tomes...</p>
              </div>
            </div>
          </details>

          <!-- Custom Model Input -->
          <details id="custom-model-section" class="mt-2 group">
            <summary class="flex items-center cursor-pointer text-[#5c4d3c] hover:text-[#2a1810] text-sm font-serif py-2 select-none">
              <span class="mr-2">‚úíÔ∏è</span>
              <span class="italic">Inscribe a custom model...</span>
              <span class="ml-auto transform transition-transform group-open:rotate-180">‚ñæ</span>
            </summary>
            
            <div class="mt-2 p-3 bg-[#e6e0d0] rounded border border-[#d4c5b0]">
              <input type="text" 
                     id="custom-model-input" 
                     placeholder="e.g., Phi-3-mini-4k-instruct-q4f16_1-MLC"
                     class="w-full px-2 py-1.5 text-sm border border-[#bcaaa4] rounded bg-[#fffef8] font-mono placeholder-[#a1887f] focus:outline-none focus:border-[#8d6e63]">
              <p id="custom-model-hint" class="text-xs text-[#8c735a] mt-1.5 italic">
                Enter any model ID from <a href="https://webllm.mlc.ai" target="_blank" class="underline hover:text-[#5d4037]">webllm.mlc.ai</a>
              </p>
              <button id="use-custom-model-btn" class="mt-2 px-3 py-1 text-sm bg-[#8d6e63] hover:bg-[#6d4c41] text-white rounded font-serif transition-colors">
                Use This Model
              </button>
            </div>
          </details>

          <!-- Reasoning Model Warning (Hidden by default) -->
          <div id="reasoning-warning" class="hidden mt-3 p-3 bg-[#fff3cd] border border-[#ffc107] rounded-md">
            <div class="flex items-start gap-2">
              <span class="text-lg">üß†</span>
              <div class="flex-1">
                <p class="font-serif font-semibold text-[#856404] text-sm">Reasoning Model Detected</p>
                <p class="text-xs text-[#856404] mt-1">
                  This model may output extended "thinking" before its response. 
                  Token visualization may behave differently than expected.
                </p>
              </div>
            </div>
          </div>

          <!-- Problematic Quantization Warning (Hidden by default) -->
          <div id="quantization-warning" class="hidden mt-3 p-3 bg-[#f8d7da] border border-[#f5c6cb] rounded-md">
            <div class="flex items-start gap-2">
              <span class="text-lg">‚ö†Ô∏è</span>
              <div class="flex-1">
                <p class="font-serif font-semibold text-[#721c24] text-sm">Compatibility Warning</p>
                <p class="text-xs text-[#721c24] mt-1">
                  This quantization (q4f32/q0f*) has known issues and may fail to generate.
                  Try a <strong>q4f16</strong> variant instead for better stability.
                </p>
              </div>
            </div>
          </div>

          <!-- Recently Summoned (Hidden if empty) -->
          <div id="recent-models-section" class="hidden mt-3">
            <p class="text-xs text-[#8c735a] font-serif italic mb-1.5">üïØÔ∏è Recently summoned:</p>
            <div id="recent-models-list" class="flex flex-wrap gap-1.5">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <button id="load-model-btn" onclick="loadSelectedModel()" class="w-full py-2 bg-[#5d4037] hover:bg-[#4e342e] text-[#efebe9] font-bold rounded border border-[#8d6e63] shadow-md cinzel tracking-wider transition-colors mb-2">
          Summon Spirit
        </button>

        <div id="loading-progress-container" class="hidden space-y-2">
          <p id="loading-status" class="text-[#5c4d3c] font-serif italic text-sm">Summoning the spirits of storytelling...</p>
          <div class="w-full bg-[#e6e0d0] h-2 rounded-full overflow-hidden border border-[#d4c5b0]">
            <div id="loading-progress" class="bg-[#8c735a] h-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p id="loading-progress-text" class="text-sm text-[#8c735a] font-mono text-right">0%</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container mx-auto px-4 py-12 max-w-6xl">
    
    <!-- Header -->
    <header class="text-center mb-12">
      <h1 class="text-5xl md:text-6xl font-bold text-[#e6e0d0] mb-3 cinzel tracking-widest text-shadow-lg">
        The Storyteller
      </h1>
      <p class="text-[#a89f91] text-lg font-serif italic">Weaving tales from the ether, one rune at a time</p>
    </header>

    <!-- Controls Panel (Leather Bound Book Style) -->
    <div class="bg-[#2a1810] rounded-lg shadow-2xl p-1 mb-8 max-w-4xl mx-auto">
      <div class="bg-[#3e2723] border border-[#5d4037] rounded p-6 relative overflow-hidden">
        <!-- Decorative corners -->
        <div class="absolute top-0 left-0 w-16 h-16 border-t-2 border-l-2 border-[#8d6e63] rounded-tl opacity-20"></div>
        <div class="absolute top-0 right-0 w-16 h-16 border-t-2 border-r-2 border-[#8d6e63] rounded-tr opacity-20"></div>
        <div class="absolute bottom-0 left-0 w-16 h-16 border-b-2 border-l-2 border-[#8d6e63] rounded-bl opacity-20"></div>
        <div class="absolute bottom-0 right-0 w-16 h-16 border-b-2 border-r-2 border-[#8d6e63] rounded-br opacity-20"></div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end relative z-10">
          
          <!-- Prompt Input -->
          <div class="md:col-span-5">
            <label class="block text-xs font-bold text-[#d7ccc8] mb-1 cinzel tracking-wide">The Tale's Beginning</label>
            <textarea 
              id="prompt-input" 
              rows="2" 
              class="w-full px-3 py-1.5 bg-[#2a1810] border border-[#5d4037] rounded text-[#d7ccc8] placeholder-[#5d4037] focus:outline-none focus:border-[#8d6e63] focus:ring-1 focus:ring-[#8d6e63] resize-none font-serif text-sm shadow-inner leading-tight"
              placeholder="e.g., A lost knight finding a dragon's library...">A robot learning to paint in a post-apocalyptic garden</textarea>
          </div>

          <!-- Parameters -->
          <div class="md:col-span-4 space-y-5">
            <div>
              <label class="block text-xs font-bold text-[#a1887f] mb-2 uppercase tracking-widest">
                Chaos (Temp): <span id="temp-display" class="text-[#d7ccc8]">0.7</span>
              </label>
              <input 
                type="range" 
                id="temp-slider" 
                min="0.1" 
                max="2.0" 
                step="0.1" 
                value="0.7"
                class="w-full h-1 bg-[#1a120b] rounded-lg appearance-none cursor-pointer accent-[#8d6e63]">
            </div>
            <div>
              <label class="block text-xs font-bold text-[#a1887f] mb-2 uppercase tracking-widest">
                Focus (Top-P): <span id="top-p-display" class="text-[#d7ccc8]">0.9</span>
              </label>
              <input 
                type="range" 
                id="top-p-slider" 
                min="0.1" 
                max="1.0" 
                step="0.05" 
                value="0.9"
                class="w-full h-1 bg-[#1a120b] rounded-lg appearance-none cursor-pointer accent-[#8d6e63]">
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="md:col-span-2 flex flex-col gap-3">
            <button 
              id="run-button" 
              class="px-6 py-3 bg-[#5d4037] hover:bg-[#6d4c41] text-[#efebe9] font-bold rounded border border-[#8d6e63] shadow-lg transform hover:-translate-y-0.5 transition-all cinzel tracking-wider">
              Write
            </button>
            <button 
              id="stop-button" 
              class="px-6 py-3 bg-[#3e2723] hover:bg-[#4e342e] text-[#ffccbc] font-bold rounded border border-[#b71c1c] shadow-lg hidden cinzel tracking-wider">
              Cease
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- The Page (Main Area) -->
      <div class="lg:col-span-8 relative">
        <!-- Book Spine Effect -->
        <div class="absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-[#d7ccc8] to-transparent z-20 opacity-50 rounded-l-lg pointer-events-none"></div>
        
        <div class="paper-sheet rounded-lg min-h-[600px] max-h-[800px] relative overflow-hidden flex flex-col">
          
          <!-- Page Header -->
          <div class="px-10 py-6 border-b border-[#e6e0d0] flex justify-between items-center">
            <span class="text-[#8c735a] font-serif italic text-sm">Chapter I</span>
            <span id="status" class="text-[#5c4d3c] font-serif text-sm border border-[#d4c5b0] px-3 py-0.5 rounded-full">
              Awaiting Inspiration
            </span>
          </div>
          
          <!-- The Text -->
          <div class="flex-grow overflow-y-auto p-10 md:p-12 bg-transparent">
            <div id="heatmap-text" class="text-xl leading-loose text-[#2c241b] font-serif">
              <p class="text-[#8c735a] italic text-center mt-20">
                "The blank page is the most terrifying thing the writer faces..."
                <br><br>
                <span class="text-sm not-italic">Type a topic above and command the quill to write.</span>
              </p>
            </div>
          </div>
          
          <!-- Page Footer -->
          <div class="px-10 py-4 border-t border-[#e6e0d0] flex justify-center">
            <span class="text-[#d4c5b0] text-xs font-serif">1</span>
          </div>
        </div>
      </div>

      <!-- Metrics Panel (Sidebar Notes) -->
      <div class="lg:col-span-4 space-y-6">
        
        <!-- Confidence Card -->
        <div class="bg-[#d8c8b0] p-6 rounded shadow-lg border border-[#e6e0d0] relative rotate-1 transform hover:rotate-0 transition-transform duration-500">
          <div class="absolute -top-3 -left-3 text-4xl text-[#d7ccc8] opacity-50">‚ùù</div>
          
          <h3 class="text-lg font-bold text-[#5d4037] mb-4 cinzel border-b border-[#e6e0d0] pb-2">Certainty</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm font-serif">
              <span class="text-[#5c4d3c]">Conviction</span>
              <span id="confidence-value" class="text-[#2c1e14] font-bold text-xl">--</span>
            </div>
            <div class="w-full bg-[#e6e0d0] h-2 rounded-full overflow-hidden">
              <div id="confidence-bar" class="bg-[#8d6e63] h-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="confidence-bar-text" class="text-[10px] text-[#a1887f] font-mono text-right tracking-tighter opacity-50"></div>
          </div>
        </div>

        <!-- Stats Card -->
        <div class="bg-[#d8c8b0] p-6 rounded shadow-lg border border-[#e6e0d0] relative -rotate-1 transform hover:rotate-0 transition-transform duration-500">
           <h3 class="text-lg font-bold text-[#5d4037] mb-4 cinzel border-b border-[#e6e0d0] pb-2">Arcana</h3>
           <div class="space-y-2 font-serif text-[#4a2c1d]">
            <div class="flex justify-between items-center py-1 border-b border-dashed border-[#e6e0d0]">
              <span class="italic">Entropy</span>
              <span id="entropy-value" class="font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center py-1 border-b border-dashed border-[#e6e0d0]">
              <span class="italic">Surprise (Pplx)</span>
              <span id="perplexity-value" class="font-semibold">--</span>
            </div>
            <!-- Hidden/Technical Metrics -->
            <div class="hidden">
              <span id="logprob-value">--</span>
              <span id="top-p-value">--</span>
            </div>
            <div class="flex justify-between items-center py-1 border-b border-dashed border-[#e6e0d0]">
              <span class="italic">Variance</span>
              <span id="variance-value" class="font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center py-1">
              <span class="italic">Coherence</span>
              <span id="coherence-value" class="font-semibold">--</span>
            </div>
          </div>
        </div>

        <!-- Legend -->
        <div class="bg-[#2a1810] p-6 rounded shadow-xl border border-[#3e2723] text-[#d7ccc8]">
          <h3 class="text-lg font-bold text-[#a1887f] mb-4 cinzel">Ink Quality</h3>
          <div class="space-y-2 text-sm font-serif">
            <div class="flex items-center gap-3">
              <span class="w-3 h-3 rounded-full bg-[#1a1a1a] border border-[#5d4037]"></span>
              <span class="text-[#d7ccc8]">Ironclad (High)</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-3 h-3 rounded-full bg-[#8d6e63]"></span>
              <span class="text-[#d7ccc8]">Faded (Medium)</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-3 h-3 rounded-full bg-[#c62828]"></span>
              <span class="text-[#d7ccc8]">Unstable (Low)</span>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- JavaScript -->
  <script>
    // Load the module and make functions available globally
    // Use relative path to work with subpath deployments
    import('./static/js/logit-viz.js').then(module => {
      window.loadSelectedModel = module.loadSelectedModel;
    }).catch(error => {
      console.error('Failed to load logit-viz module:', error);
    });
  </script>
  
  <!-- Tooltip (Hidden) -->
  <div id="token-tooltip" class="hidden fixed z-50 bg-[#fffef8] border border-[#d4c5b0] p-3 rounded shadow-xl max-w-xs">
    <div class="text-[#5d4037] font-bold text-xs uppercase tracking-wider border-b border-[#e6e0d0] mb-2 pb-1">
      Alternatives
    </div>
    <div id="tooltip-candidates" class="space-y-1 font-serif text-sm text-[#2c1e14]"></div>
  </div>

</body>
</html>
